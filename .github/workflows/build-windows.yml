name: 纯净编译 scrcpy v3.3.1 客户端

on:
  workflow_dispatch:  # 仅手动触发，避免自动浪费时间

jobs:
  build:
    runs-on: windows-latest
    steps:
      - name: 安装 MSYS2 环境（官方推荐）
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          install: >-
            git
            mingw-w64-x86_64-meson
            mingw-w64-x86_64-ninja
            mingw-w64-x86_64-gcc
            mingw-w64-x86_64-ffmpeg
            mingw-w64-x86_64-libusb
            mingw-w64-x86_64-pkgconf
            mingw-w64-x86_64-SDL2

      - name: 拉取源码并彻底删除服务器目录
        shell: msys2 {0}
        run: |
          git clone https://github.com/Genymobile/scrcpy.git
          cd scrcpy
          git checkout v3.3.1  # 锁定版本
          rm -rf server/  # 物理删除服务器目录，永绝后患
          # 确认服务器目录已删除
          if [ -d "server" ]; then echo "服务器目录未删除，失败！"; exit 1; fi

      - name: 修补主配置文件（移除服务器引用）
        shell: msys2 {0}
        run: |
          cd scrcpy
          # 从主meson.build中删除所有关于server的配置
          sed -i '/subdir.*server/d' meson.build
          # 验证修改（确保没有server相关内容）
          if grep -q "server" meson.build; then echo "配置文件修补失败"; exit 1; fi

      - name: 配置编译（仅客户端必需选项）
        shell: msys2 {0}
        run: |
          cd scrcpy
          meson setup build --buildtype=release \
            -Dffmpeg=enabled \    # 仅保留客户端必需的FFmpeg依赖
            -Dlibusb=enabled \    # 仅保留USB连接依赖
            -Dsdl=enabled \       # 仅保留窗口显示依赖
            -Dsystemd=disabled    # Windows无需systemd

      - name: 编译客户端
        shell: msys2 {0}
        run: |
          cd scrcpy
          ninja -C build
          # 确认exe生成
          if [ ! -f "build/src/scrcpy.exe" ]; then echo "编译失败，无exe文件"; exit 1; fi

      - name: 打包所有运行依赖
        shell: msys2 {0}
        run: |
          # 创建输出目录
          mkdir -p output
          # 复制客户端exe
          cp scrcpy/build/src/scrcpy.exe output/
          # 复制必需的DLL（根据官方运行时依赖）
          cp /mingw64/bin/libusb-1.0.dll output/
          cp /mingw64/bin/avcodec-61.dll output/
          cp /mingw64/bin/avformat-61.dll output/
          cp /mingw64/bin/avutil-59.dll output/
          cp /mingw64/bin/swscale-8.dll output/
          cp /mingw64/bin/SDL2.dll output/
          # 确认所有文件存在
          ls -l output/

      - name: 上传最终产物
        uses: actions/upload-artifact@v4
        with:
          name: scrcpy-v3.3.1-客户端
          path: output/*
